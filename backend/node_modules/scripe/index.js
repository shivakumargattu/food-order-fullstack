
module.exports = function (read, writer) {
  if (!writer.writable) throw new Error('not writable')

  // destroy the current stream if
  // writing is no longer possible
  var destroy = read.destroy
  writer.on('error', destroy)
  writer.on('close', destroy)
  writer.on('finish', destroy)
  read.cleanup(function () {
    writer.removeListener('error', destroy)
    writer.removeListener('close', destroy)
    writer.removeListener('finish', destroy)
  })

  var ended = false
  read(next)

  return writer

  function next(err, data) {
    if (err) return writer.emit('error', err)
    if (!data) {
      if (ended) return
      ended = true
      writer.end()
      return
    }

    if (writer.write(data)) return read(next)
    writer.once('drain', read.bind(null, next))
  }
}